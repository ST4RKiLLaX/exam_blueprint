{% extends "base.html" %}

{% block title %}Tasks & Routines{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">üìã Tasks & Routines</h1>
        <p class="text-gray-600">Automate your email monitoring and other scheduled tasks</p>
    </div>

    <!-- Add Task Button -->
    <div class="mb-6">
        <button onclick="showCreateModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
            ‚ûï Add New Task
        </button>
    </div>

    <!-- Tasks Table -->
    <div class="bg-white shadow-sm rounded-lg border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Active Tasks ({{ tasks|length }})</h2>
        </div>
        
        {% if tasks %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Task</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Agent</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Schedule</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stats</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for task in tasks %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div>
                                <div class="text-sm font-medium text-gray-900">{{ task.name }}</div>
                                {% if task.description %}
                                <div class="text-sm text-gray-500">{{ task.description }}</div>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                {% if task.task_type == 'email_check' %}bg-blue-100 text-blue-800
                                {% elif task.task_type == 'generate_report' %}bg-green-100 text-green-800
                                {% elif task.task_type == 'cleanup' %}bg-yellow-100 text-yellow-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {% if task.task_type == 'email_check' %}üìß Email Check
                                {% elif task.task_type == 'generate_report' %}üìä Report
                                {% elif task.task_type == 'cleanup' %}üßπ Cleanup
                                {% elif task.task_type == 'sync' %}üîÑ Sync
                                {% else %}{{ task.task_type }}{% endif %}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">
                            {% if task.agent_name %}
                                <div>{{ task.agent_name }}</div>
                                {% if task.email_account_name %}
                                <div class="text-xs text-gray-500">{{ task.email_account_name }}</div>
                                {% endif %}
                            {% else %}
                                <span class="text-gray-400">No agent</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">{{ task.schedule_description }}</div>
                            {% if task.next_run %}
                            <div class="text-xs text-gray-500">
                                Next: {{ task.next_run[:16].replace('T', ' ') }}
                            </div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                {% if task.status == 'active' %}bg-green-100 text-green-800
                                {% elif task.status == 'paused' %}bg-yellow-100 text-yellow-800
                                {% elif task.status == 'error' %}bg-red-100 text-red-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {% if task.status == 'active' %}‚úÖ Active
                                {% elif task.status == 'paused' %}‚è∏Ô∏è Paused
                                {% elif task.status == 'error' %}‚ùå Error
                                {% else %}{{ task.status }}{% endif %}
                            </span>
                            {% if task.is_due %}
                            <div class="text-xs text-orange-600 font-medium mt-1">‚è∞ Due Now</div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">
                            {% if task.run_count > 0 %}
                            <div>Runs: {{ task.run_count }}</div>
                            <div class="text-xs text-green-600">Success: {{ "%.1f"|format(task.success_rate) }}%</div>
                            {% if task.last_error %}
                            <div class="text-xs text-red-600" title="{{ task.last_error }}">Last Error</div>
                            {% endif %}
                            {% else %}
                            <span class="text-gray-400">No runs yet</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center space-x-2">
                                <!-- Run Now -->
                                <form method="post" class="inline">
                                    <input type="hidden" name="action" value="run_now">
                                    <input type="hidden" name="task_id" value="{{ task.task_id }}">
                                    <button type="submit" class="text-blue-600 hover:text-blue-900 text-sm font-medium" title="Run Now">
                                        ‚ñ∂Ô∏è
                                    </button>
                                </form>
                                
                                <!-- Pause/Resume -->
                                {% if task.status == 'active' %}
                                <form method="post" class="inline">
                                    <input type="hidden" name="action" value="pause">
                                    <input type="hidden" name="task_id" value="{{ task.task_id }}">
                                    <button type="submit" class="text-yellow-600 hover:text-yellow-900 text-sm font-medium" title="Pause">
                                        ‚è∏Ô∏è
                                    </button>
                                </form>
                                {% elif task.status == 'paused' %}
                                <form method="post" class="inline">
                                    <input type="hidden" name="action" value="resume">
                                    <input type="hidden" name="task_id" value="{{ task.task_id }}">
                                    <button type="submit" class="text-green-600 hover:text-green-900 text-sm font-medium" title="Resume">
                                        ‚ñ∂Ô∏è
                                    </button>
                                </form>
                                {% endif %}
                                
                                <!-- Edit -->
                                <button onclick="editTask('{{ task.task_id }}', '{{ task.name }}', '{{ task.description }}', '{{ task.task_type }}', '{{ task.agent_id }}', '{{ task.email_account_id }}', '{{ task.schedule_type }}', {{ task.schedule_interval }}, '{{ task.schedule_time }}', {{ task.business_hours_only|lower }}, '{{ task.status }}')" 
                                        class="text-indigo-600 hover:text-indigo-900 text-sm font-medium" title="Edit">
                                    ‚úèÔ∏è
                                </button>
                                
                                <!-- Delete -->
                                <button onclick="deleteTask('{{ task.task_id }}', '{{ task.name }}')" 
                                        class="text-red-600 hover:text-red-900 text-sm font-medium" title="Delete">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="px-6 py-8 text-center">
            <div class="text-gray-400 text-lg mb-2">üìã</div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No tasks yet</h3>
            <p class="text-gray-500 mb-4">Create your first automated task to get started</p>
            <button onclick="showCreateModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                ‚ûï Add Your First Task
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Create Task Modal -->
<div id="createModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Create New Task</h3>
        </div>
        <form method="post">
            <input type="hidden" name="action" value="create">
            <div class="px-6 py-4 space-y-4">
                <!-- Task Name -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Task Name *</label>
                    <input type="text" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Monitor CNA Inbox">
                </div>
                
                <!-- Task Type -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Task Type *</label>
                    <select name="task_type" required onchange="toggleEmailFields(this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select type...</option>
                        {% for task_type in task_types %}
                        <option value="{{ task_type.value }}">{{ task_type.label }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Description -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea name="description" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Optional description"></textarea>
                </div>
                
                <!-- Email Check Fields (shown only for email_check type) -->
                <div id="emailFields" class="space-y-4 hidden">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Agent *</label>
                        <select name="agent_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select agent...</option>
                            {% for agent in agents %}
                            <option value="{{ agent.agent_id }}">{{ agent.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email Account *</label>
                        <select name="email_account_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select email account...</option>
                            {% for account in accounts %}
                            <option value="{{ account.account_id }}">{{ account.email_address }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <!-- Schedule Type -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Schedule Type *</label>
                    <select name="schedule_type" required onchange="toggleScheduleFields(this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        {% for schedule_type in schedule_types %}
                        <option value="{{ schedule_type.value }}" {% if schedule_type.value == 'minutes' %}selected{% endif %}>{{ schedule_type.label }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Schedule Interval -->
                <div id="intervalField">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Interval (minutes) *</label>
                    <input type="number" name="schedule_interval" value="15" min="1" max="1440" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Recommended: 15 minutes for email monitoring</p>
                </div>
                
                <!-- Schedule Time (for daily) -->
                <div id="timeField" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Time (HH:MM)</label>
                    <input type="time" name="schedule_time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- Business Hours Only -->
                <div>
                    <label class="flex items-center">
                        <input type="checkbox" name="business_hours_only" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">Business hours only (Mon-Fri, 9AM-5PM)</span>
                    </label>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                <button type="button" onclick="hideCreateModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors">
                    Create Task
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Task Modal -->
<div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Edit Task</h3>
        </div>
        <form method="post">
            <input type="hidden" name="action" value="update">
            <input type="hidden" name="task_id" id="editTaskId">
            <div class="px-6 py-4 space-y-4">
                <!-- Task Name -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Task Name *</label>
                    <input type="text" name="name" id="editName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- Description -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea name="description" id="editDescription" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                
                <!-- Agent (for email check tasks) -->
                <div id="editEmailFields" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Agent</label>
                        <select name="agent_id" id="editAgentId" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select agent...</option>
                            {% for agent in agents %}
                            <option value="{{ agent.agent_id }}">{{ agent.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email Account</label>
                        <select name="email_account_id" id="editEmailAccountId" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select email account...</option>
                            {% for account in accounts %}
                            <option value="{{ account.account_id }}">{{ account.email_address }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <!-- Schedule Type -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Schedule Type</label>
                    <select name="schedule_type" id="editScheduleType" onchange="toggleEditScheduleFields(this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        {% for schedule_type in schedule_types %}
                        <option value="{{ schedule_type.value }}">{{ schedule_type.label }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Schedule Interval -->
                <div id="editIntervalField">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Interval (minutes)</label>
                    <input type="number" name="schedule_interval" id="editScheduleInterval" min="1" max="1440" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- Schedule Time -->
                <div id="editTimeField" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Time (HH:MM)</label>
                    <input type="time" name="schedule_time" id="editScheduleTime" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- Business Hours Only -->
                <div>
                    <label class="flex items-center">
                        <input type="checkbox" name="business_hours_only" id="editBusinessHoursOnly" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">Business hours only (Mon-Fri, 9AM-5PM)</span>
                    </label>
                </div>
                
                <!-- Status -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select name="status" id="editStatus" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="active">Active</option>
                        <option value="paused">Paused</option>
                        <option value="disabled">Disabled</option>
                    </select>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                <button type="button" onclick="hideEditModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors">
                    Update Task
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Modal functions
function showCreateModal() {
    document.getElementById('createModal').classList.remove('hidden');
    document.getElementById('createModal').classList.add('flex');
}

function hideCreateModal() {
    document.getElementById('createModal').classList.add('hidden');
    document.getElementById('createModal').classList.remove('flex');
}

function showEditModal() {
    document.getElementById('editModal').classList.remove('hidden');
    document.getElementById('editModal').classList.add('flex');
}

function hideEditModal() {
    document.getElementById('editModal').classList.add('hidden');
    document.getElementById('editModal').classList.remove('flex');
}

// Toggle email fields based on task type
function toggleEmailFields(taskType) {
    const emailFields = document.getElementById('emailFields');
    if (taskType === 'email_check') {
        emailFields.classList.remove('hidden');
    } else {
        emailFields.classList.add('hidden');
    }
}

// Toggle schedule fields based on schedule type
function toggleScheduleFields(scheduleType) {
    const intervalField = document.getElementById('intervalField');
    const timeField = document.getElementById('timeField');
    const intervalLabel = intervalField.querySelector('label');
    const intervalInput = intervalField.querySelector('input');
    
    if (scheduleType === 'minutes') {
        intervalField.classList.remove('hidden');
        timeField.classList.add('hidden');
        intervalLabel.textContent = 'Interval (minutes) *';
        intervalInput.placeholder = 'e.g., 15';
        intervalInput.min = '1';
        intervalInput.max = '1440';
    } else if (scheduleType === 'hourly') {
        intervalField.classList.remove('hidden');
        timeField.classList.add('hidden');
        intervalLabel.textContent = 'Minutes past hour (0-59) *';
        intervalInput.placeholder = 'e.g., 0';
        intervalInput.min = '0';
        intervalInput.max = '59';
    } else if (scheduleType === 'daily') {
        intervalField.classList.add('hidden');
        timeField.classList.remove('hidden');
    } else {
        intervalField.classList.add('hidden');
        timeField.classList.add('hidden');
    }
}

function toggleEditScheduleFields(scheduleType) {
    const intervalField = document.getElementById('editIntervalField');
    const timeField = document.getElementById('editTimeField');
    const intervalLabel = intervalField.querySelector('label');
    const intervalInput = intervalField.querySelector('input');
    
    if (scheduleType === 'minutes') {
        intervalField.classList.remove('hidden');
        timeField.classList.add('hidden');
        intervalLabel.textContent = 'Interval (minutes)';
        intervalInput.min = '1';
        intervalInput.max = '1440';
    } else if (scheduleType === 'hourly') {
        intervalField.classList.remove('hidden');
        timeField.classList.add('hidden');
        intervalLabel.textContent = 'Minutes past hour (0-59)';
        intervalInput.min = '0';
        intervalInput.max = '59';
    } else if (scheduleType === 'daily') {
        intervalField.classList.add('hidden');
        timeField.classList.remove('hidden');
    } else {
        intervalField.classList.add('hidden');
        timeField.classList.add('hidden');
    }
}

// Edit task function
function editTask(taskId, name, description, taskType, agentId, emailAccountId, scheduleType, scheduleInterval, scheduleTime, businessHoursOnly, status) {
    document.getElementById('editTaskId').value = taskId;
    document.getElementById('editName').value = name;
    document.getElementById('editDescription').value = description;
    document.getElementById('editAgentId').value = agentId;
    document.getElementById('editEmailAccountId').value = emailAccountId;
    document.getElementById('editScheduleType').value = scheduleType;
    document.getElementById('editScheduleInterval').value = scheduleInterval;
    document.getElementById('editScheduleTime').value = scheduleTime;
    document.getElementById('editBusinessHoursOnly').checked = businessHoursOnly;
    document.getElementById('editStatus').value = status;
    
    // Show/hide fields based on task type
    const emailFields = document.getElementById('editEmailFields');
    if (taskType === 'email_check') {
        emailFields.classList.remove('hidden');
    } else {
        emailFields.classList.add('hidden');
    }
    
    // Adjust schedule fields
    toggleEditScheduleFields(scheduleType);
    
    showEditModal();
}

// Delete task function
function deleteTask(taskId, taskName) {
    if (confirm(`Are you sure you want to delete the task "${taskName}"?`)) {
        const form = document.createElement('form');
        form.method = 'post';
        form.innerHTML = `
            <input type="hidden" name="action" value="delete">
            <input type="hidden" name="task_id" value="${taskId}">
        `;
        document.body.appendChild(form);
        form.submit();
    }
}

// Close modals when clicking outside
document.getElementById('createModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideCreateModal();
    }
});

document.getElementById('editModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideEditModal();
    }
});
</script>
{% endblock %}
