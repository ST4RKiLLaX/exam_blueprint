{% extends "base.html" %}

{% block title %}Question Library - Exam Blueprint{% endblock %}

{% block extra_head %}
<style>
    .dark .question-library-page .bg-white { background-color: rgb(31 41 55); }
    .dark .question-library-page .bg-gray-50 { background-color: rgb(55 65 81); }
    .dark .question-library-page .text-gray-900 { color: rgb(243 244 246); }
    .dark .question-library-page .text-gray-700 { color: rgb(209 213 219); }
    .dark .question-library-page .text-gray-600 { color: rgb(156 163 175); }
    .dark .question-library-page .text-gray-500 { color: rgb(156 163 175); }
    .dark .question-library-page .border-gray-200 { border-color: rgb(75 85 99); }
    .dark .question-library-page .border-gray-300 { border-color: rgb(107 114 128); }
    .dark .question-library-page .bg-blue-100 { background-color: rgb(30 64 175 / 0.5); }
    .dark .question-library-page .text-blue-800 { color: rgb(219 234 254); }
    .dark .question-library-page .bg-green-100 { background-color: rgb(21 128 61 / 0.55); }
    .dark .question-library-page .text-green-800 { color: rgb(220 252 231); }
    .dark .question-library-page input,
    .dark .question-library-page select,
    .dark .question-library-page textarea {
        background-color: rgb(31 41 55);
        color: rgb(243 244 246);
        border-color: rgb(107 114 128);
    }
    .dark #editQuestionModal .bg-white { background-color: rgb(31 41 55); }
    .dark #editQuestionModal .text-gray-900 { color: rgb(243 244 246); }
    .dark #editQuestionModal .text-gray-700 { color: rgb(209 213 219); }
    .dark #editQuestionModal .border-gray-200 { border-color: rgb(75 85 99); }
    .dark #editQuestionModal .border-gray-300 { border-color: rgb(107 114 128); }
    .dark #editQuestionModal input,
    .dark #editQuestionModal select,
    .dark #editQuestionModal textarea {
        background-color: rgb(17 24 39);
        color: rgb(243 244 246);
        border-color: rgb(107 114 128);
    }
    .dark #editQuestionModal #cancelEditBtn {
        background-color: rgb(55 65 81);
        color: rgb(243 244 246);
    }
    .dark #editQuestionModal #cancelEditBtn:hover { background-color: rgb(75 85 99); }
    .dark #editQuestionModal .bg-gray-100 { background-color: rgb(55 65 81); }
    .dark #editQuestionModal .hover\:bg-gray-200:hover { background-color: rgb(75 85 99); }
</style>
{% endblock %}

{% block content %}
<div class="question-library-page max-w-7xl mx-auto space-y-6">
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h1 class="text-2xl font-bold text-gray-900">Question Library</h1>
        <p class="text-gray-600 mt-1">Manage saved questions and filter by metadata.</p>
    </div>

    <section class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Domain</label>
                <select id="filterDomain" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="">All</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Difficulty</label>
                <select id="filterDifficulty" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="">All</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select id="filterStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="">All</option>
                    <option value="active">Active</option>
                    <option value="draft">Draft</option>
                    <option value="archived">Archived</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Topic</label>
                <input id="filterTopic" type="text" placeholder="e.g. access control"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            <div class="flex items-end gap-2">
                <button id="applyFiltersBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Apply
                </button>
                <button id="clearFiltersBtn" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                    Clear
                </button>
            </div>
        </div>
    </section>

    <section class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Question</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Domain</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Difficulty</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Topics</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody id="questionsTableBody" class="divide-y divide-gray-200 bg-white"></tbody>
            </table>
        </div>

        <div class="px-4 py-3 border-t border-gray-200 flex items-center justify-between">
            <div id="paginationInfo" class="text-sm text-gray-600"></div>
            <div class="flex gap-2">
                <button id="prevPageBtn" class="px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">Prev</button>
                <button id="nextPageBtn" class="px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">Next</button>
            </div>
        </div>
    </section>
</div>

<div id="editQuestionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white border border-gray-200 rounded-lg shadow-xl w-full max-w-3xl p-6 space-y-4">
        <h2 class="text-xl font-semibold text-gray-900">Edit Question</h2>
        <input type="hidden" id="editQuestionId">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Question</label>
            <textarea id="editQuestionText" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
        </div>
        <div>
            <div class="flex items-center justify-between mb-2">
                <label class="block text-sm font-medium text-gray-700">Choices</label>
                <button type="button" id="addOptionBtn" class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                    + Add choice
                </button>
            </div>
            <div id="editOptionsContainer" class="space-y-2"></div>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Explanation</label>
            <textarea id="editExplanation" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Topics (comma separated)</label>
                <input id="editTopics" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select id="editStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="active">Active</option>
                    <option value="draft">Draft</option>
                    <option value="archived">Archived</option>
                </select>
            </div>
        </div>
        <div class="flex justify-end gap-2 pt-2">
            <button id="cancelEditBtn" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Cancel</button>
            <button id="saveEditBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
        </div>
    </div>
</div>

<script>
    let currentPage = 1;
    let totalPages = 1;
    const pageSize = 20;

    function escapeHtml(value) {
        return String(value || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function truncateText(value, maxLen = 110) {
        const text = String(value || '');
        return text.length > maxLen ? `${text.slice(0, maxLen)}...` : text;
    }

    function sanitizeQuestionText(value) {
        const text = String(value || '').trim();
        return text.replace(/^question\s*[:\-]\s*/i, '').trim();
    }

    function normalizeOptions(rawOptions, answerText) {
        const answerNormalized = String(answerText || '').trim().toLowerCase();
        if (!Array.isArray(rawOptions)) return [];
        return rawOptions
            .map((item, idx) => {
                if (typeof item === 'string') {
                    const text = item.trim();
                    if (!text) return null;
                    const label = String.fromCharCode(65 + idx);
                    return {
                        label,
                        text,
                        is_correct: answerNormalized === label.toLowerCase() || answerNormalized === text.toLowerCase()
                    };
                }
                if (item && typeof item === 'object') {
                    const text = String(item.text || '').trim();
                    if (!text) return null;
                    const label = String(item.label || String.fromCharCode(65 + idx)).trim().toUpperCase();
                    const isCorrect = Boolean(item.is_correct)
                        || answerNormalized === label.toLowerCase()
                        || answerNormalized === text.toLowerCase();
                    return { label, text, is_correct: isCorrect };
                }
                return null;
            })
            .filter(Boolean);
    }

    function normalizeQuestionAndOptions(question) {
        const questionText = sanitizeQuestionText(question.question_text || '');
        let options = normalizeOptions(question.options || [], question.answer_text || '');

        // Repair legacy bad parses where first option mirrors/contains the question text.
        if (options.length >= 2) {
            const first = String(options[0]?.text || '').toLowerCase().trim();
            const q = questionText.toLowerCase().trim();
            if (first && q && (first === q || first.includes(q) || q.includes(first))) {
                options = options.slice(1);
            }
        }

        // Always relabel sequentially A..H after normalization.
        options = options.map((opt, idx) => ({
            ...opt,
            label: String.fromCharCode(65 + idx),
        }));

        return { questionText, options };
    }

    function renderOptionsEditor(options) {
        const container = document.getElementById('editOptionsContainer');
        const normalized = options.length ? options : [{ label: 'A', text: '', is_correct: false }];
        container.innerHTML = normalized.map((option, idx) => `
            <div class="option-row grid grid-cols-12 gap-2 items-center" data-index="${idx}">
                <div class="col-span-1 text-xs font-semibold text-gray-500">${escapeHtml(option.label || String.fromCharCode(65 + idx))}</div>
                <input type="text" class="option-input col-span-9 px-2 py-1 border border-gray-300 rounded"
                       value="${escapeHtml(option.text || '')}" placeholder="Choice text">
                <label class="col-span-1 text-xs text-gray-600 flex items-center justify-center">
                    <input type="radio" name="correct_option" class="correct-option-radio"
                           ${option.is_correct ? 'checked' : ''}>
                </label>
                <button type="button" class="remove-option-btn col-span-1 px-2 py-1 text-xs bg-red-100 text-red-800 rounded hover:bg-red-200">×</button>
            </div>
        `).join('');

        const rows = Array.from(container.querySelectorAll('.option-row'));
        rows.forEach((row) => {
            const removeBtn = row.querySelector('.remove-option-btn');
            if (!removeBtn) return;
            removeBtn.onclick = () => {
                row.remove();
                relabelOptionRows();
            };
        });
    }

    function relabelOptionRows() {
        const rows = Array.from(document.querySelectorAll('#editOptionsContainer .option-row'));
        rows.forEach((row, idx) => {
            const label = row.querySelector('.text-xs.font-semibold');
            if (label) label.textContent = String.fromCharCode(65 + idx);
        });
    }

    function collectOptionsFromEditor() {
        const rows = Array.from(document.querySelectorAll('#editOptionsContainer .option-row'));
        const options = rows.map((row, idx) => {
            const input = row.querySelector('.option-input');
            const radio = row.querySelector('.correct-option-radio');
            const text = String(input?.value || '').trim();
            if (!text) return null;
            return {
                label: String.fromCharCode(65 + idx),
                text,
                is_correct: Boolean(radio?.checked)
            };
        }).filter(Boolean);
        return options;
    }

    function selectedFilters() {
        return {
            domain: document.getElementById('filterDomain').value,
            difficulty_level_id: document.getElementById('filterDifficulty').value,
            status: document.getElementById('filterStatus').value,
            topic: document.getElementById('filterTopic').value.trim()
        };
    }

    async function loadQuestions() {
        const params = new URLSearchParams({
            page: String(currentPage),
            page_size: String(pageSize)
        });
        const filters = selectedFilters();
        Object.entries(filters).forEach(([key, val]) => {
            if (val) params.set(key, val);
        });

        const response = await fetch(`/api/questions?${params.toString()}`);
        const data = await response.json();
        if (!data.success) {
            alert(data.error || 'Failed to load questions');
            return;
        }

        totalPages = data.pagination.total_pages || 1;
        renderFilterOptions(data.filters);
        renderRows(data.questions || []);
        renderPaginationInfo(data.pagination);
    }

    function renderFilterOptions(filters) {
        const domainSelect = document.getElementById('filterDomain');
        const difficultySelect = document.getElementById('filterDifficulty');
        const currentDomain = domainSelect.value;
        const currentDifficulty = difficultySelect.value;

        domainSelect.innerHTML = '<option value="">All</option>';
        (filters.domains || []).forEach(domain => {
            domainSelect.innerHTML += `<option value="${escapeHtml(domain)}">${escapeHtml(domain)}</option>`;
        });
        domainSelect.value = currentDomain;

        difficultySelect.innerHTML = '<option value="">All</option>';
        (filters.difficulty_level_ids || []).forEach(level => {
            difficultySelect.innerHTML += `<option value="${escapeHtml(level)}">${escapeHtml(level)}</option>`;
        });
        difficultySelect.value = currentDifficulty;
    }

    function renderRows(questions) {
        const tbody = document.getElementById('questionsTableBody');
        if (!questions.length) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-4 py-6 text-center text-sm text-gray-500">No saved questions found.</td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = questions.map(q => {
            const topics = (q.topics || []).map(topic =>
                `<span class="inline-block mr-1 mb-1 px-2 py-0.5 text-xs rounded bg-blue-100 text-blue-800">${escapeHtml(topic)}</span>`
            ).join('') || '<span class="text-gray-500">—</span>';
            const normalized = normalizeQuestionAndOptions(q);

            return `
                <tr>
                    <td class="px-4 py-3 text-sm text-gray-900">
                        <div class="font-medium">${escapeHtml(truncateText(normalized.questionText))}</div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-700">${escapeHtml(q.domain || '—')}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${escapeHtml(q.difficulty_display_name || q.difficulty_level_id || '—')}</td>
                    <td class="px-4 py-3 text-sm">${topics}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${escapeHtml(q.status || 'active')}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${escapeHtml((q.created_at || '').replace('T', ' ').slice(0, 19))}</td>
                    <td class="px-4 py-3 text-sm">
                        <button class="mr-2 px-2 py-1 bg-blue-100 text-blue-800 rounded hover:bg-blue-200">Edit</button>
                        <button class="px-2 py-1 bg-red-100 text-red-800 rounded hover:bg-red-200">Delete</button>
                    </td>
                </tr>
            `;
        }).join('');

        // Rebind with current objects (avoid inline string escaping pitfalls)
        const rows = tbody.querySelectorAll('tr');
        questions.forEach((q, idx) => {
            const row = rows[idx];
            if (!row) return;
            const [editBtn, delBtn] = row.querySelectorAll('button');
            if (editBtn) editBtn.onclick = () => openEditModal(q);
            if (delBtn) delBtn.onclick = () => deleteQuestion(q.id);
        });
    }

    function renderPaginationInfo(pagination) {
        document.getElementById('paginationInfo').textContent =
            `Page ${pagination.page} of ${pagination.total_pages} • ${pagination.total} total`;
        document.getElementById('prevPageBtn').disabled = pagination.page <= 1;
        document.getElementById('nextPageBtn').disabled = pagination.page >= pagination.total_pages;
    }

    function openEditModal(question) {
        document.getElementById('editQuestionId').value = question.id;
        const normalized = normalizeQuestionAndOptions(question);
        document.getElementById('editQuestionText').value = normalized.questionText || '';
        const normalizedOptions = normalized.options;
        renderOptionsEditor(normalizedOptions);
        document.getElementById('editExplanation').value = question.explanation || '';
        document.getElementById('editTopics').value = (question.topics || []).join(', ');
        document.getElementById('editStatus').value = question.status || 'active';
        document.getElementById('editQuestionModal').classList.remove('hidden');
    }

    function closeEditModal() {
        document.getElementById('editQuestionModal').classList.add('hidden');
    }

    async function saveEdit() {
        const id = document.getElementById('editQuestionId').value;
        const options = collectOptionsFromEditor();
        const correctOption = options.find(option => option.is_correct);
        const payload = {
            question_text: sanitizeQuestionText(document.getElementById('editQuestionText').value),
            answer_text: correctOption
                ? correctOption.text
                : null,
            explanation: document.getElementById('editExplanation').value,
            options: options,
            topics: document.getElementById('editTopics').value,
            status: document.getElementById('editStatus').value
        };
        const response = await fetch(`/api/questions/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const data = await response.json();
        if (!data.success) {
            alert(data.error || 'Failed to update question');
            return;
        }
        closeEditModal();
        await loadQuestions();
    }

    async function deleteQuestion(id) {
        if (!confirm('Delete this question?')) return;
        const response = await fetch(`/api/questions/${id}`, { method: 'DELETE' });
        const data = await response.json();
        if (!data.success) {
            alert(data.error || 'Failed to delete question');
            return;
        }
        await loadQuestions();
    }

    document.getElementById('applyFiltersBtn').addEventListener('click', async () => {
        currentPage = 1;
        await loadQuestions();
    });
    document.getElementById('clearFiltersBtn').addEventListener('click', async () => {
        document.getElementById('filterDomain').value = '';
        document.getElementById('filterDifficulty').value = '';
        document.getElementById('filterStatus').value = '';
        document.getElementById('filterTopic').value = '';
        currentPage = 1;
        await loadQuestions();
    });
    document.getElementById('prevPageBtn').addEventListener('click', async () => {
        if (currentPage > 1) {
            currentPage -= 1;
            await loadQuestions();
        }
    });
    document.getElementById('nextPageBtn').addEventListener('click', async () => {
        if (currentPage < totalPages) {
            currentPage += 1;
            await loadQuestions();
        }
    });
    document.getElementById('cancelEditBtn').addEventListener('click', closeEditModal);
    document.getElementById('saveEditBtn').addEventListener('click', saveEdit);
    document.getElementById('addOptionBtn').addEventListener('click', () => {
        const existing = collectOptionsFromEditor();
        const nextLabel = String.fromCharCode(65 + existing.length);
        existing.push({ label: nextLabel, text: '', is_correct: false });
        renderOptionsEditor(existing);
    });

    loadQuestions();
</script>
{% endblock %}
