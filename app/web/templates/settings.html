{% extends "base.html" %}

{% block title %}Settings - AI Agent Management{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">System Settings</h1>
                <p class="text-gray-600 mt-1">Configure AI models, pricing, and system preferences</p>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="mb-4 p-4 rounded-lg {% if category == 'error' %}bg-red-50 text-red-700 border border-red-200{% else %}bg-green-50 text-green-700 border border-green-200{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- AI Model Configuration -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">ü§ñ AI Model Configuration</h2>
            
            <form method="POST" class="space-y-6">
                <input type="hidden" name="action" value="update_model">
                
                <div class="bg-gray-50 rounded-lg p-6">
                    <label for="chat_model" class="block text-sm font-medium text-gray-700 mb-3">
                        Chat Model Selection
                    </label>
                    
                    <select id="chat_model" name="chat_model" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="gpt-5" {% if current_model == 'gpt-5' %}selected{% endif %}>
                            GPT-5 - Latest & Most Advanced ($0.10/1K tokens) üöÄ
                        </option>
                        <option value="gpt-4o" {% if current_model == 'gpt-4o' %}selected{% endif %}>
                            GPT-4o - High Performance ($0.05/1K tokens) ‚ö°
                        </option>
                        <option value="gpt-4-turbo" {% if current_model == 'gpt-4-turbo' %}selected{% endif %}>
                            GPT-4 Turbo - Fast & Efficient ($0.03/1K tokens) üí®
                        </option>
                        <option value="gpt-4" {% if current_model == 'gpt-4' %}selected{% endif %}>
                            GPT-4 - Reliable Standard ($0.06/1K tokens) üîß
                        </option>
                        <option value="gpt-3.5-turbo" {% if current_model == 'gpt-3.5-turbo' %}selected{% endif %}>
                            GPT-3.5 Turbo - Cost Effective ($0.002/1K tokens) üí∞
                        </option>
                    </select>
                    
                    <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-medium text-blue-900 mb-2">üí° Model Comparison</h4>
                        <div class="text-sm text-blue-800 space-y-1">
                            <div><strong>GPT-5:</strong> Latest model with PhD-level expertise, best reasoning</div>
                            <div><strong>GPT-4o:</strong> Optimized for speed and performance, multimodal</div>
                            <div><strong>GPT-4 Turbo:</strong> Faster responses, good balance of cost/performance</div>
                            <div><strong>GPT-4:</strong> Original GPT-4, very reliable for complex tasks</div>
                            <div><strong>GPT-3.5 Turbo:</strong> Most cost-effective, good for simple tasks</div>
                        </div>
                    </div>
                </div>

                <!-- Cost Estimation -->
                <div class="bg-yellow-50 rounded-lg p-6">
                    <h4 class="font-medium text-yellow-900 mb-3">üìä Estimated Monthly Costs</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div class="bg-white p-3 rounded border">
                            <div class="font-medium text-gray-900">Light Usage</div>
                            <div class="text-gray-600">~100 emails/month</div>
                            <div class="text-lg font-bold text-green-600" id="light-cost">$2-15</div>
                        </div>
                        <div class="bg-white p-3 rounded border">
                            <div class="font-medium text-gray-900">Medium Usage</div>
                            <div class="text-gray-600">~500 emails/month</div>
                            <div class="text-lg font-bold text-blue-600" id="medium-cost">$10-75</div>
                        </div>
                        <div class="bg-white p-3 rounded border">
                            <div class="font-medium text-gray-900">Heavy Usage</div>
                            <div class="text-gray-600">~2000 emails/month</div>
                            <div class="text-lg font-bold text-orange-600" id="heavy-cost">$40-300</div>
                        </div>
                    </div>
                    <p class="text-xs text-yellow-700 mt-2">
                        *Estimates based on average email length. Actual costs may vary based on email complexity and knowledge base usage.
                    </p>
                </div>

                <!-- Temperature Setting -->
                <div>
                    <label for="temperature" class="block text-sm font-medium text-gray-700 mb-2">
                        Response Creativity (Temperature)
                    </label>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-500">Conservative</span>
                        <input type="range" id="temperature" name="temperature" min="0" max="1" step="0.1" 
                               value="{{ current_temperature or 0.5 }}" 
                               class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <span class="text-sm text-gray-500">Creative</span>
                        <span id="temp-value" class="text-sm font-medium text-gray-900 min-w-[3rem]">{{ current_temperature or 0.5 }}</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">
                        Lower values = more consistent, higher values = more creative responses
                    </p>
                </div>

                <div class="flex justify-end">
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        üíæ Save Settings
                    </button>
                </div>
            </form>
        </div>

        <!-- Current Usage Stats -->
        <div class="border-t pt-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">üìà Usage Statistics</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-blue-600">{{ stats.total_emails or 0 }}</div>
                    <div class="text-sm text-blue-800">Emails Processed</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-green-600">{{ stats.active_agents or 0 }}</div>
                    <div class="text-sm text-green-800">Active Agents</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-purple-600">{{ stats.knowledge_bases or 0 }}</div>
                    <div class="text-sm text-purple-800">Knowledge Bases</div>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-orange-600">{{ current_model or 'gpt-5' }}</div>
                    <div class="text-sm text-orange-800">Current Model</div>
                </div>
            </div>
        </div>

        <!-- System Maintenance -->
        <div class="border-t pt-6 mt-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">üßπ System Maintenance</h2>
            <div class="bg-yellow-50 p-4 rounded-lg mb-4">
                <h4 class="font-medium text-yellow-900 mb-2">Knowledge Base Cleanup</h4>
                <p class="text-sm text-yellow-800 mb-3">
                    If you're experiencing issues with deleted knowledge bases still appearing in responses, 
                    use this cleanup tool to remove orphaned data.
                </p>
                <form method="POST" class="inline">
                    <input type="hidden" name="action" value="cleanup_knowledge_bases">
                    <button type="submit" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors">
                        üßπ Clean Up Knowledge Bases
                    </button>
                </form>
            </div>
        </div>

        <!-- API Key Management -->
        <div class="border-t pt-6 mt-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">üîë API Key Management</h2>
            
            <!-- Current API Key Status -->
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <div class="flex items-center justify-between mb-3">
                    <div>
                        <h4 class="font-medium text-gray-900">OpenAI API Key Status</h4>
                        <p class="text-sm text-gray-600">Current API key configuration and connection status</p>
                    </div>
                    <span id="api-status" class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium 
                        {% if api_key_status == 'valid' %}bg-green-100 text-green-800{% elif api_key_status == 'invalid' %}bg-red-100 text-red-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                        {% if api_key_status == 'valid' %}‚úÖ Valid{% elif api_key_status == 'invalid' %}‚ùå Invalid{% else %}‚ùì Unknown{% endif %}
                    </span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="font-medium text-gray-700">Key Preview:</span>
                        <span id="key-preview" class="ml-2 font-mono text-gray-600">sk-...{{ api_key_preview or 'Not Set' }}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">Last Updated:</span>
                        <span class="ml-2 text-gray-600">{{ api_key_updated or 'Never' }}</span>
                    </div>
                </div>
            </div>

            <!-- Update API Key Form -->
            <div class="bg-blue-50 p-4 rounded-lg">
                <h4 class="font-medium text-blue-900 mb-3">Update API Key</h4>
                <form method="POST" class="space-y-4" id="apiKeyForm" onsubmit="return updateAndTestApiKey(event)">
                    <input type="hidden" name="action" value="update_api_key">
                    
                    <div>
                        <label for="api_key" class="block text-sm font-medium text-gray-700 mb-2">
                            OpenAI API Key
                        </label>
                        <div class="relative">
                            <input type="password" id="api_key" name="api_key" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"
                                   placeholder="sk-..." 
                                   autocomplete="new-password">
                            <button type="button" onclick="toggleApiKeyVisibility()" 
                                    class="absolute right-3 top-2 text-gray-400 hover:text-gray-600">
                                <span id="eye-icon">üëÅÔ∏è</span>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">
                            Your API key will be securely stored and encrypted. Get your key from 
                            <a href="https://platform.openai.com/api-keys" target="_blank" class="text-blue-600 hover:text-blue-800">OpenAI Platform</a>
                        </p>
                    </div>

                    <div class="flex items-center space-x-3">
                        <button type="submit" id="updateApiKeyBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            üîê Update & Test API Key
                        </button>
                        <div id="api-test-spinner" class="hidden">
                            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- API Usage Information -->
            <div class="bg-yellow-50 p-4 rounded-lg mt-4">
                <h4 class="font-medium text-yellow-900 mb-2">üí° API Key Security Tips</h4>
                <ul class="text-sm text-yellow-800 space-y-1">
                    <li>‚Ä¢ Never share your API key with others</li>
                    <li>‚Ä¢ Set usage limits in your OpenAI dashboard</li>
                    <li>‚Ä¢ Monitor your usage regularly</li>
                    <li>‚Ä¢ Rotate your keys periodically for security</li>
                </ul>
                <div class="mt-3 pt-3 border-t border-yellow-200">
                    <a href="https://platform.openai.com/usage" target="_blank" 
                       class="text-sm text-yellow-700 hover:text-yellow-900 underline">
                        üìä View Usage Dashboard ‚Üí
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Update temperature display
document.getElementById('temperature').addEventListener('input', function() {
    document.getElementById('temp-value').textContent = this.value;
});

// Update cost estimates based on model selection
document.getElementById('chat_model').addEventListener('change', function() {
    const model = this.value;
    const costs = {
        'gpt-5': { light: '$15', medium: '$75', heavy: '$300' },
        'gpt-4o': { light: '$7', medium: '$35', heavy: '$150' },
        'gpt-4-turbo': { light: '$5', medium: '$25', heavy: '$100' },
        'gpt-4': { light: '$9', medium: '$45', heavy: '$180' },
        'gpt-3.5-turbo': { light: '$2', medium: '$10', heavy: '$40' }
    };
    
    if (costs[model]) {
        document.getElementById('light-cost').textContent = costs[model].light;
        document.getElementById('medium-cost').textContent = costs[model].medium;
        document.getElementById('heavy-cost').textContent = costs[model].heavy;
    }
});

// API Key Management Functions
function toggleApiKeyVisibility() {
    const input = document.getElementById('api_key');
    const eyeIcon = document.getElementById('eye-icon');
    
    if (input.type === 'password') {
        input.type = 'text';
        eyeIcon.textContent = 'üôà';
    } else {
        input.type = 'password';
        eyeIcon.textContent = 'üëÅÔ∏è';
    }
}

async function updateAndTestApiKey(event) {
    event.preventDefault();
    
    const apiKey = document.getElementById('api_key').value;
    const statusElement = document.getElementById('api-status');
    const submitBtn = document.getElementById('updateApiKeyBtn');
    const spinner = document.getElementById('api-test-spinner');
    
    if (!apiKey) {
        alert('Please enter an API key');
        return false;
    }
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.textContent = 'üîÑ Updating & Testing...';
    spinner.classList.remove('hidden');
    statusElement.className = 'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800';
    statusElement.textContent = 'üîÑ Testing...';
    
    try {
        // First update the API key
        const updateResponse = await fetch('/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                'action': 'update_api_key',
                'api_key': apiKey
            })
        });
        
        if (!updateResponse.ok) {
            throw new Error('Failed to update API key');
        }
        
        // Then test the API key
        const testResponse = await fetch('/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                'action': 'test_api_key',
                'api_key': apiKey
            })
        });
        
        const result = await testResponse.json();
        
        if (result.success) {
            statusElement.className = 'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
            statusElement.textContent = '‚úÖ Valid';
            alert('‚úÖ API key updated and tested successfully!');
            
            // Update the page info
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            statusElement.className = 'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800';
            statusElement.textContent = '‚ùå Invalid';
            alert('‚ö†Ô∏è API key was updated but test failed: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        statusElement.className = 'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800';
        statusElement.textContent = '‚ùå Error';
        alert('‚ùå Error updating API key: ' + error.message);
    } finally {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.textContent = 'üîê Update & Test API Key';
        spinner.classList.add('hidden');
    }
    
    return false; // Prevent default form submission
}
</script>
{% endblock %}
