{% extends "base.html" %}

{% block title %}Email Account Management{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900">üìß Email Account Management</h1>
        <button onclick="showCreateModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
            ‚ûï Add Email Account
        </button>
    </div>

    <!-- Email Accounts Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {% for account in accounts %}
        <div class="bg-white rounded-lg shadow-md card-hover">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">{{ account.name }}</h3>
                        <p class="text-sm text-gray-600">{{ account.email_address }}</p>
                    </div>
                    <span class="px-2 py-1 text-xs font-medium rounded-full {% if account.status == 'active' %}bg-green-100 text-green-800{% elif account.status == 'error' %}bg-red-100 text-red-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ account.status }}
                    </span>
                </div>
                
                <div class="space-y-3 mb-6">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="text-gray-500">IMAP Host:</p>
                            <p class="font-medium">{{ account.imap_host or 'Not configured' }}</p>
                        </div>
                        <div>
                            <p class="text-gray-500">SMTP Host:</p>
                            <p class="font-medium">{{ account.smtp_host or 'Not configured' }}</p>
                        </div>
                    </div>
                    
                    <div class="text-xs text-gray-500">
                        <p>Created: {{ account.created_at[:10] }}</p>
                        <p>ID: {{ account.account_id[:8] }}...</p>
                    </div>
                </div>
                
                <div class="flex flex-wrap gap-2">
                    <button onclick="editAccount('{{ account.account_id }}', '{{ account.name }}', '{{ account.email_address }}', '{{ account.imap_host }}', {{ account.imap_port }}, '{{ account.smtp_host }}', {{ account.smtp_port }}, '{{ account.username }}', {{ account.imap_ssl|lower }}, {{ account.smtp_ssl|lower }}, '{{ account.status }}')" 
                            class="flex-1 bg-blue-50 hover:bg-blue-100 text-blue-700 px-3 py-2 rounded text-sm font-medium transition-colors">
                        ‚úèÔ∏è Edit
                    </button>
                    <button onclick="testConnection('{{ account.account_id }}')" 
                            class="flex-1 bg-yellow-50 hover:bg-yellow-100 text-yellow-700 px-3 py-2 rounded text-sm font-medium transition-colors">
                        üîå Test
                    </button>
                    <button onclick="deleteAccount('{{ account.account_id }}', '{{ account.name }}')" 
                            class="flex-1 bg-red-50 hover:bg-red-100 text-red-700 px-3 py-2 rounded text-sm font-medium transition-colors">
                        üóëÔ∏è Delete
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
        
        {% if not accounts %}
        <div class="col-span-full">
            <div class="text-center py-12 bg-white rounded-lg shadow-md">
                <div class="text-6xl mb-4">üìß</div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">No email accounts found</h3>
                <p class="text-gray-600 mb-4">Add your first email account to get started!</p>
                <button onclick="showCreateModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                    Add Email Account
                </button>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Thread Management Section -->
    <div class="mt-12">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-900">üí¨ Email Threads</h2>
            <div class="flex gap-3">
                <button onclick="loadThreads()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                    üîÑ Refresh
                </button>
                <button onclick="clearAllThreads()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                    üóëÔ∏è Clear All
                </button>
            </div>
        </div>

        <!-- Threads List -->
        <div id="threadsContainer" class="bg-white rounded-lg shadow-md">
            <div class="p-6 text-center text-gray-500">
                <div class="text-4xl mb-2">üí¨</div>
                <p>Click "Refresh" to load email threads</p>
            </div>
        </div>

        <!-- Thread Details Modal -->
        <div id="threadModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden">
                    <div class="flex justify-between items-center p-6 border-b">
                        <h3 id="threadModalTitle" class="text-lg font-semibold">Thread Details</h3>
                        <button onclick="closeThreadModal()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="threadModalContent" class="p-6 overflow-y-auto max-h-[70vh]">
                        <!-- Thread messages will be loaded here -->
                    </div>
                    <div class="flex justify-end gap-3 p-6 border-t">
                        <button onclick="closeThreadModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                        <button id="deleteThreadBtn" onclick="deleteCurrentThread()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">Delete Thread</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Email Account Modal -->
<div id="createAccountModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
        <div class="p-6 border-b">
            <h3 class="text-lg font-semibold text-gray-900">Add Email Account</h3>
        </div>
        <form method="POST">
            <div class="p-6 space-y-4">
                <input type="hidden" name="action" value="create">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="createName" class="block text-sm font-medium text-gray-700 mb-1">Account Name *</label>
                        <input type="text" id="createName" name="name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="createEmailAddress" class="block text-sm font-medium text-gray-700 mb-1">Email Address *</label>
                        <input type="email" id="createEmailAddress" name="email_address" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="createUsername" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="createUsername" name="username" 
                               placeholder="Leave empty to use email address"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="createPassword" class="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                        <input type="password" id="createPassword" name="password" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="border-t pt-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-md font-medium text-gray-900">IMAP Settings (Incoming Mail)</h4>
                        <select id="providerPreset" onchange="applyPreset()" class="text-sm border border-gray-300 rounded px-2 py-1">
                            <option value="">Select Provider Preset</option>
                            <option value="gmail">Gmail</option>
                            <option value="outlook">Outlook/Hotmail</option>
                            <option value="yahoo">Yahoo Mail</option>
                            <option value="ionos">Ionos (1&1) - Port 465</option>
                            <option value="ionos587">Ionos (1&1) - Port 587</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="col-span-2">
                            <label for="createImapHost" class="block text-sm font-medium text-gray-700 mb-1">IMAP Host</label>
                            <input type="text" id="createImapHost" name="imap_host" 
                                   placeholder="imap.gmail.com"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="createImapPort" class="block text-sm font-medium text-gray-700 mb-1">Port</label>
                            <input type="number" id="createImapPort" name="imap_port" value="993" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="mt-2">
                        <label class="flex items-center">
                            <input type="hidden" name="imap_ssl" value="off">
                            <input type="checkbox" name="imap_ssl" value="on" checked class="rounded">
                            <span class="ml-2 text-sm text-gray-700">Use SSL/TLS</span>
                        </label>
                    </div>
                </div>
                
                <div class="border-t pt-4">
                    <h4 class="text-md font-medium text-gray-900 mb-3">SMTP Settings (Outgoing Mail)</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="col-span-2">
                            <label for="createSmtpHost" class="block text-sm font-medium text-gray-700 mb-1">SMTP Host</label>
                            <input type="text" id="createSmtpHost" name="smtp_host" 
                                   placeholder="smtp.gmail.com"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="createSmtpPort" class="block text-sm font-medium text-gray-700 mb-1">Port</label>
                            <input type="number" id="createSmtpPort" name="smtp_port" value="587" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="mt-2">
                        <label class="flex items-center">
                            <input type="hidden" name="smtp_ssl" value="off">
                            <input type="checkbox" name="smtp_ssl" value="on" checked class="rounded">
                            <span class="ml-2 text-sm text-gray-700">Use SSL/TLS</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t flex justify-end space-x-3">
                <button type="button" onclick="hideCreateModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors">Add Account</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Email Account Modal -->
<div id="editAccountModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
        <div class="p-6 border-b">
            <h3 class="text-lg font-semibold text-gray-900">Edit Email Account</h3>
        </div>
        <form method="POST">
            <div class="p-6 space-y-4">
                <input type="hidden" name="action" value="update">
                <input type="hidden" name="account_id" id="editAccountId">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="editName" class="block text-sm font-medium text-gray-700 mb-1">Account Name *</label>
                        <input type="text" id="editName" name="name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editEmailAddress" class="block text-sm font-medium text-gray-700 mb-1">Email Address *</label>
                        <input type="email" id="editEmailAddress" name="email_address" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label for="editUsername" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="editUsername" name="username" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="editPassword" name="password" 
                               placeholder="Leave empty to keep current password"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editStatus" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="editStatus" name="status" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="error">Error</option>
                        </select>
                    </div>
                </div>
                
                <div class="border-t pt-4">
                    <h4 class="text-md font-medium text-gray-900 mb-3">IMAP Settings</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="col-span-2">
                            <label for="editImapHost" class="block text-sm font-medium text-gray-700 mb-1">IMAP Host</label>
                            <input type="text" id="editImapHost" name="imap_host" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="editImapPort" class="block text-sm font-medium text-gray-700 mb-1">Port</label>
                            <input type="number" id="editImapPort" name="imap_port" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="mt-2">
                        <label class="flex items-center">
                            <input type="hidden" name="imap_ssl" value="off">
                            <input type="checkbox" id="editImapSsl" name="imap_ssl" value="on" class="rounded">
                            <span class="ml-2 text-sm text-gray-700">Use SSL/TLS</span>
                        </label>
                    </div>
                </div>
                
                <div class="border-t pt-4">
                    <h4 class="text-md font-medium text-gray-900 mb-3">SMTP Settings</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="col-span-2">
                            <label for="editSmtpHost" class="block text-sm font-medium text-gray-700 mb-1">SMTP Host</label>
                            <input type="text" id="editSmtpHost" name="smtp_host" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="editSmtpPort" class="block text-sm font-medium text-gray-700 mb-1">Port</label>
                            <input type="number" id="editSmtpPort" name="smtp_port" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="mt-2">
                        <label class="flex items-center">
                            <input type="hidden" name="smtp_ssl" value="off">
                            <input type="checkbox" id="editSmtpSsl" name="smtp_ssl" value="on" class="rounded">
                            <span class="ml-2 text-sm text-gray-700">Use SSL/TLS</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t flex justify-end space-x-3">
                <button type="button" onclick="hideEditModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors">Update Account</button>
            </div>
        </form>
    </div>
</div>

<script>
let currentAccountId = null;

const emailPresets = {
    gmail: {
        imapHost: 'imap.gmail.com',
        imapPort: 993,
        imapSsl: true,
        smtpHost: 'smtp.gmail.com',
        smtpPort: 587,
        smtpSsl: true
    },
    outlook: {
        imapHost: 'outlook.office365.com',
        imapPort: 993,
        imapSsl: true,
        smtpHost: 'smtp.office365.com',
        smtpPort: 587,
        smtpSsl: true
    },
    yahoo: {
        imapHost: 'imap.mail.yahoo.com',
        imapPort: 993,
        imapSsl: true,
        smtpHost: 'smtp.mail.yahoo.com',
        smtpPort: 587,
        smtpSsl: true
    },
    ionos: {
        imapHost: 'imap.ionos.com',
        imapPort: 993,
        imapSsl: true,
        smtpHost: 'smtp.ionos.com',
        smtpPort: 465,
        smtpSsl: true
    },
    ionos587: {
        imapHost: 'imap.ionos.com',
        imapPort: 993,
        imapSsl: true,
        smtpHost: 'smtp.ionos.com',
        smtpPort: 587,
        smtpSsl: true
    }
};

function applyPreset() {
    const preset = document.getElementById('providerPreset').value;
    if (preset && emailPresets[preset]) {
        const settings = emailPresets[preset];
        document.getElementById('createImapHost').value = settings.imapHost;
        document.getElementById('createImapPort').value = settings.imapPort;
        document.getElementById('createSmtpHost').value = settings.smtpHost;
        document.getElementById('createSmtpPort').value = settings.smtpPort;
        document.querySelector('input[name="imap_ssl"]').checked = settings.imapSsl;
        document.querySelector('input[name="smtp_ssl"]').checked = settings.smtpSsl;
        
        // Show authentication help
        showAuthHelp(preset);
    }
}

function showAuthHelp(provider) {
    let helpText = '';
    switch(provider) {
        case 'gmail':
            helpText = `
                <strong>Gmail Authentication:</strong><br>
                ‚Ä¢ You must use an App Password, not your regular Gmail password<br>
                ‚Ä¢ Enable 2-Factor Authentication in your Google Account<br>
                ‚Ä¢ Generate App Password: Google Account ‚Üí Security ‚Üí App passwords<br>
                ‚Ä¢ Use your full email as username: yourname@gmail.com
            `;
            break;
        case 'outlook':
            helpText = `
                <strong>Outlook/Hotmail Authentication:</strong><br>
                ‚Ä¢ You can use your regular password if 2FA is disabled<br>
                ‚Ä¢ For 2FA accounts, generate an App Password<br>
                ‚Ä¢ Microsoft Account ‚Üí Security ‚Üí Advanced security options ‚Üí App passwords<br>
                ‚Ä¢ Use your full email as username
            `;
            break;
        case 'yahoo':
            helpText = `
                <strong>Yahoo Mail Authentication:</strong><br>
                ‚Ä¢ You must use an App Password<br>
                ‚Ä¢ Yahoo Account ‚Üí Account Security ‚Üí Generate app password<br>
                ‚Ä¢ Use your full email as username: yourname@yahoo.com
            `;
            break;
        case 'ionos':
        case 'ionos587':
            helpText = `
                <strong>Ionos (1&1) Authentication:</strong><br>
                ‚Ä¢ Use your regular email password<br>
                ‚Ä¢ Username should be your full email address<br>
                ‚Ä¢ Port 465: SSL/TLS encryption (recommended)<br>
                ‚Ä¢ Port 587: STARTTLS encryption (alternative)<br>
                ‚Ä¢ Requires TLS 1.2 or higher support<br>
                ‚Ä¢ Ensure email account is fully activated in Ionos control panel
            `;
            break;
    }
    
    if (helpText) {
        // Create or update help div
        let helpDiv = document.getElementById('authHelp');
        if (!helpDiv) {
            helpDiv = document.createElement('div');
            helpDiv.id = 'authHelp';
            helpDiv.className = 'mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg';
            document.querySelector('.border-t.pt-4').appendChild(helpDiv);
        }
        helpDiv.innerHTML = `<div class="text-sm text-blue-800">${helpText}</div>`;
    }
}

function showCreateModal() {
    document.getElementById('createAccountModal').classList.remove('hidden');
    document.getElementById('createAccountModal').classList.add('flex');
}

function hideCreateModal() {
    document.getElementById('createAccountModal').classList.add('hidden');
    document.getElementById('createAccountModal').classList.remove('flex');
}

function editAccount(accountId, name, emailAddress, imapHost, imapPort, smtpHost, smtpPort, username, imapSsl, smtpSsl, status) {
    document.getElementById('editAccountId').value = accountId;
    document.getElementById('editName').value = name;
    document.getElementById('editEmailAddress').value = emailAddress;
    document.getElementById('editImapHost').value = imapHost;
    document.getElementById('editImapPort').value = imapPort;
    document.getElementById('editSmtpHost').value = smtpHost;
    document.getElementById('editSmtpPort').value = smtpPort;
    document.getElementById('editUsername').value = username;
    document.getElementById('editImapSsl').checked = (imapSsl === true || imapSsl === 'true');
    document.getElementById('editSmtpSsl').checked = (smtpSsl === true || smtpSsl === 'true');
    document.getElementById('editStatus').value = status;
    
    document.getElementById('editAccountModal').classList.remove('hidden');
    document.getElementById('editAccountModal').classList.add('flex');
}

function hideEditModal() {
    document.getElementById('editAccountModal').classList.add('hidden');
    document.getElementById('editAccountModal').classList.remove('flex');
}

function testConnection(accountId) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.innerHTML = `
        <input type="hidden" name="action" value="test_connection">
        <input type="hidden" name="account_id" value="${accountId}">
    `;
    document.body.appendChild(form);
    form.submit();
}

function deleteAccount(accountId, accountName) {
    if (confirm(`Are you sure you want to delete email account "${accountName}"? This action cannot be undone.`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.innerHTML = `
            <input type="hidden" name="action" value="delete">
            <input type="hidden" name="account_id" value="${accountId}">
        `;
        document.body.appendChild(form);
        form.submit();
    }
}

// Close modals when clicking outside
document.addEventListener('click', function(event) {
    const modals = ['createAccountModal', 'editAccountModal'];
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (event.target === modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    });
});

// Thread Management Functions
let currentThreadKey = null;

async function loadThreads() {
    try {
        const response = await fetch('/api/threads');
        const data = await response.json();
        
        if (data.success) {
            displayThreads(data.threads);
        } else {
            showError('Failed to load threads');
        }
    } catch (error) {
        console.error('Error loading threads:', error);
        showError('Error loading threads');
    }
}

function displayThreads(threads) {
    const container = document.getElementById('threadsContainer');
    
    if (threads.length === 0) {
        container.innerHTML = `
            <div class="p-6 text-center text-gray-500">
                <div class="text-4xl mb-2">üì≠</div>
                <p>No email threads found</p>
            </div>
        `;
        return;
    }
    
    const threadsHtml = threads.map(thread => `
        <div class="border-b last:border-b-0 p-4 hover:bg-gray-50 cursor-pointer" onclick="viewThread('${thread.thread_key}')">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="font-medium text-gray-900">${escapeHtml(thread.participant)}</span>
                        <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full">${thread.message_count} messages</span>
                        <span class="text-xs px-2 py-1 rounded-full ${thread.last_role === 'user' ? 'bg-green-100 text-green-800' : 'bg-purple-100 text-purple-800'}">
                            Last: ${thread.last_role === 'user' ? 'User' : 'Assistant'}
                        </span>
                    </div>
                    <p class="text-sm font-medium text-gray-700 mb-1">${escapeHtml(thread.subject)}</p>
                    <p class="text-xs text-gray-500">${escapeHtml(thread.last_activity)}</p>
                </div>
                <button onclick="event.stopPropagation(); deleteThread('${thread.thread_key}')" 
                        class="text-red-500 hover:text-red-700 p-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = `
        <div class="divide-y">
            ${threadsHtml}
        </div>
    `;
}

async function viewThread(threadKey) {
    try {
        const response = await fetch(`/api/threads/${encodeURIComponent(threadKey)}`);
        const data = await response.json();
        
        if (data.success) {
            currentThreadKey = threadKey;
            displayThreadDetails(data.thread);
            document.getElementById('threadModal').classList.remove('hidden');
        } else {
            showError('Failed to load thread details');
        }
    } catch (error) {
        console.error('Error loading thread details:', error);
        showError('Error loading thread details');
    }
}

function displayThreadDetails(thread) {
    const messages = thread.messages || [];
    const title = messages.length > 0 ? `${messages[0].subject || 'No Subject'}` : 'Thread Details';
    
    document.getElementById('threadModalTitle').textContent = title;
    
    const messagesHtml = messages.map((msg, index) => `
        <div class="mb-6 ${msg.role === 'user' ? 'bg-blue-50' : 'bg-purple-50'} rounded-lg p-4">
            <div class="flex justify-between items-start mb-2">
                <div class="flex items-center gap-2">
                    <span class="font-medium ${msg.role === 'user' ? 'text-blue-900' : 'text-purple-900'}">
                        ${msg.role === 'user' ? 'üë§ ' + escapeHtml(msg.from || 'User') : 'ü§ñ Assistant'}
                    </span>
                    <span class="text-xs text-gray-500">#${index + 1}</span>
                </div>
                ${msg.message_id ? `<span class="text-xs text-gray-400 font-mono">${escapeHtml(msg.message_id)}</span>` : ''}
            </div>
            <div class="text-sm text-gray-800 whitespace-pre-wrap">${escapeHtml(msg.content || '')}</div>
        </div>
    `).join('');
    
    document.getElementById('threadModalContent').innerHTML = messagesHtml || '<p class="text-gray-500">No messages in this thread</p>';
}

function closeThreadModal() {
    document.getElementById('threadModal').classList.add('hidden');
    currentThreadKey = null;
}

async function deleteThread(threadKey) {
    if (!confirm('Are you sure you want to delete this thread? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/threads/${encodeURIComponent(threadKey)}`, {
            method: 'DELETE'
        });
        const data = await response.json();
        
        if (data.success) {
            showSuccess(data.message);
            loadThreads(); // Refresh the list
        } else {
            showError(data.error || 'Failed to delete thread');
        }
    } catch (error) {
        console.error('Error deleting thread:', error);
        showError('Error deleting thread');
    }
}

async function deleteCurrentThread() {
    if (currentThreadKey) {
        await deleteThread(currentThreadKey);
        closeThreadModal();
    }
}

async function clearAllThreads() {
    if (!confirm('Are you sure you want to clear ALL email threads? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/threads', {
            method: 'DELETE'
        });
        const data = await response.json();
        
        if (data.success) {
            showSuccess(data.message);
            loadThreads(); // Refresh the list
        } else {
            showError('Failed to clear threads');
        }
    } catch (error) {
        console.error('Error clearing threads:', error);
        showError('Error clearing threads');
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Auto-load threads when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadThreads();
});
</script>
{% endblock %}
