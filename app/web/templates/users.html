{% extends "base.html" %}

{% block title %}User Management - Exam Blueprint{% endblock %}

{% block extra_head %}
<style>
    .dark .users-page .bg-white { background-color: rgb(31 41 55); }
    .dark .users-page .bg-gray-50 { background-color: rgb(55 65 81); }
    .dark .users-page .bg-green-50 { background-color: rgb(20 83 45 / 0.25); }
    .dark .users-page .bg-red-50 { background-color: rgb(127 29 29 / 0.25); }
    .dark .users-page .bg-blue-100 { background-color: rgb(30 58 138 / 0.35); }
    .dark .users-page .bg-purple-100 { background-color: rgb(88 28 135 / 0.35); }
    .dark .users-page .bg-green-100 { background-color: rgb(21 128 61 / 0.6); }
    .dark .users-page .bg-red-100 { background-color: rgb(185 28 28 / 0.6); }
    .dark .users-page .bg-gray-100 { background-color: rgb(75 85 99 / 0.9); }
    .dark .users-page .text-gray-900 { color: rgb(243 244 246); }
    .dark .users-page .text-gray-600 { color: rgb(156 163 175); }
    .dark .users-page .text-gray-500 { color: rgb(156 163 175); }
    .dark .users-page .text-green-800 { color: rgb(187 247 208); }
    .dark .users-page .text-red-800 { color: rgb(252 165 165); }
    .dark .users-page .text-gray-800 { color: rgb(229 231 235); }
    .dark .users-page .text-blue-800 { color: rgb(191 219 254); }
    .dark .users-page .text-purple-800 { color: rgb(221 214 254); }
    .dark .users-page .border-green-200 { border-color: rgb(22 101 52 / 0.55); }
    .dark .users-page .border-red-200 { border-color: rgb(153 27 27 / 0.55); }
    .dark .users-page .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: rgb(75 85 99); }
    .dark .users-page .hover\:text-indigo-900:hover,
    .dark .users-page .hover\:text-blue-900:hover,
    .dark .users-page .hover\:text-orange-900:hover,
    .dark .users-page .hover\:text-green-900:hover,
    .dark .users-page .hover\:text-red-900:hover { color: rgb(243 244 246); }
    .dark .users-page input,
    .dark .users-page select,
    .dark .users-page textarea {
        background-color: rgb(31 41 55);
        color: rgb(243 244 246);
        border-color: rgb(107 114 128);
    }
    .dark #addUserModal .bg-white,
    .dark #editEmailModal .bg-white { background-color: rgb(31 41 55); }
    .dark #addUserModal .bg-gray-100,
    .dark #editEmailModal .bg-gray-100 { background-color: rgb(75 85 99); }
    .dark #addUserModal .text-gray-900,
    .dark #editEmailModal .text-gray-900 { color: rgb(243 244 246); }
    .dark #addUserModal .text-gray-700,
    .dark #editEmailModal .text-gray-700 { color: rgb(209 213 219); }
    .dark #addUserModal .text-gray-600,
    .dark #editEmailModal .text-gray-600 { color: rgb(156 163 175); }
    .dark #addUserModal .border-gray-300,
    .dark #editEmailModal .border-gray-300 { border-color: rgb(107 114 128); }
    .dark #addUserModal .hover\:bg-gray-50:hover,
    .dark #editEmailModal .hover\:bg-gray-50:hover { background-color: rgb(107 114 128); }
    .dark #addUserModal input,
    .dark #addUserModal select,
    .dark #addUserModal textarea,
    .dark #editEmailModal input,
    .dark #editEmailModal select,
    .dark #editEmailModal textarea {
        background-color: rgb(31 41 55);
        color: rgb(243 244 246);
        border-color: rgb(107 114 128);
    }
    .dark #addUserModal input::placeholder,
    .dark #addUserModal textarea::placeholder,
    .dark #editEmailModal input::placeholder,
    .dark #editEmailModal textarea::placeholder { color: rgb(156 163 175); }
</style>
{% endblock %}

{% block content %}
<div class="users-page max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">User Management</h1>
        <p class="text-gray-600 mt-2">Manage user accounts and permissions</p>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="mb-6 p-4 rounded-lg {% if category == 'success' %}bg-green-50 border border-green-200{% else %}bg-red-50 border border-red-200{% endif %}">
                <p class="text-sm {% if category == 'success' %}text-green-800{% else %}text-red-800{% endif %}">{{ message }}</p>
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Add User Button -->
    <div class="mb-6">
        <button onclick="showAddUserModal()" class="gradient-bg text-white px-6 py-3 rounded-lg font-medium hover:opacity-90 transition-opacity">
            + Add New User
        </button>
    </div>

    <!-- Users Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Login</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for user in users %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ user.email }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% for role in user.roles %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {% if role.name == 'admin' %}bg-purple-100 text-purple-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                            {{ role.name }}
                        </span>
                        {% endfor %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if user.is_locked() %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                            Locked
                        </span>
                        {% elif user.active %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            Active
                        </span>
                        {% else %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                            Inactive
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {% if user.last_login_at %}
                        {{ user.last_login_at.strftime('%Y-%m-%d %H:%M') }}
                        {% else %}
                        Never
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editEmail('{{ user.email }}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit Email</button>
                        <button onclick="resetPassword('{{ user.email }}')" class="text-blue-600 hover:text-blue-900 mr-3">Reset Password</button>
                        {% if user.active %}
                        <button onclick="toggleUserStatus('{{ user.email }}', false)" class="text-orange-600 hover:text-orange-900 mr-3">Deactivate</button>
                        {% else %}
                        <button onclick="toggleUserStatus('{{ user.email }}', true)" class="text-green-600 hover:text-green-900 mr-3">Activate</button>
                        {% endif %}
                        {% if user.email != current_user.email %}
                        <button onclick="deleteUser('{{ user.email }}')" class="text-red-600 hover:text-red-900">Delete</button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Audit Log Section -->
    <div class="mt-12">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Audit Log</h2>
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Admin</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Target User</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP Address</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for log in audit_logs %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ log.admin_user }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{{ log.action_type }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ log.target_user }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ log.ip_address or 'N/A' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div id="addUserModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-8 border w-full max-w-md shadow-lg rounded-lg bg-white">
        <h3 class="text-2xl font-bold text-gray-900 mb-6">Add New User</h3>
        <form id="addUserForm" method="POST" action="/users/add" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                <input type="email" name="email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                <input type="password" name="password" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                <select name="role" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" onclick="hideAddUserModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">
                    Create User
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Email Modal -->
<div id="editEmailModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-8 border w-full max-w-md shadow-lg rounded-lg bg-white">
        <h3 class="text-2xl font-bold text-gray-900 mb-6">Edit Email Address</h3>
        <form id="editEmailForm" class="space-y-4">
            <input type="hidden" id="oldEmail" name="old_email">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Current Email</label>
                <input type="text" id="currentEmailDisplay" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">New Email</label>
                <input type="email" id="newEmail" name="new_email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" onclick="hideEditEmailModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">
                    Update Email
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function showAddUserModal() {
    document.getElementById('addUserModal').classList.remove('hidden');
}

function hideAddUserModal() {
    document.getElementById('addUserModal').classList.add('hidden');
}

function editEmail(email) {
    document.getElementById('oldEmail').value = email;
    document.getElementById('currentEmailDisplay').value = email;
    document.getElementById('newEmail').value = '';
    document.getElementById('editEmailModal').classList.remove('hidden');
}

function hideEditEmailModal() {
    document.getElementById('editEmailModal').classList.add('hidden');
}

document.getElementById('editEmailForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const oldEmail = document.getElementById('oldEmail').value;
    const newEmail = document.getElementById('newEmail').value;
    
    if (oldEmail === newEmail) {
        alert('New email must be different from current email');
        return;
    }
    
    fetch('/users/edit-email', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({old_email: oldEmail, new_email: newEmail})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Email updated successfully from ${oldEmail} to ${newEmail}`);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error updating email: ' + error);
    });
});

function resetPassword(email) {
    if (confirm(`Reset password for ${email}?`)) {
        fetch('/users/reset-password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: email})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`New password: ${data.password}\n\nPlease save this password.`);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}

function toggleUserStatus(email, activate) {
    const action = activate ? 'activate' : 'deactivate';
    if (confirm(`${action.charAt(0).toUpperCase() + action.slice(1)} user ${email}?`)) {
        fetch('/users/toggle-status', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: email, active: activate})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}

function deleteUser(email) {
    if (confirm(`Are you sure you want to delete user ${email}? This action cannot be undone.`)) {
        fetch('/users/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: email})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}
</script>
{% endblock %}
